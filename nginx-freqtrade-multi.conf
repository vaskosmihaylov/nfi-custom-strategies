# NGINX Configuration for Multi-Strategy Freqtrade - CORRECTED
# This fixes the double-path issue by using simple base paths

# WebSocket upgrade mapping (required for FreqUI)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    listen [::]:80;

    server_name freq.gaiaderma.com;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # CORS headers for cross-origin requests
    add_header Access-Control-Allow-Origin "freq.gaiaderma.com";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE";
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

    # Main FreqUI location - Default to NFI-X6 strategy
    location / {
        proxy_pass http://127.0.0.1:8080;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Strategy-specific paths (FreqUI will append /api/v1/* to these)
    
    # NFI-X6 Strategy - Base path /nfi-x6
    location /nfi-x6/ {
        proxy_pass http://127.0.0.1:8080/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # BandtasticFiboHyper Strategy - Base path /bandtastic
    location /bandtastic/ {
        proxy_pass http://127.0.0.1:8082/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # FVG Strategy - Base path /fvg
    location /fvg/ {
        proxy_pass http://127.0.0.1:8085/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # MacheteV8b Strategy - Base path /machetev8b
    location /machetev8b/ {
        proxy_pass http://127.0.0.1:8090/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # ElliotV5_SMA Strategy - Base path /elliotv5_sma
    location /elliotv5_sma/ {
        proxy_pass http://127.0.0.1:8091/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # BinClucMadV1 Strategy - Base path /binclucmadv1
    location /binclucmadv1/ {
        proxy_pass http://127.0.0.1:8092/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # NASOSv4 Strategy - Base path /nasosv4
    location /nasosv4/ {
        proxy_pass http://127.0.0.1:8093/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # MartyEMA Strategy - Base path /martyema
    location /martyema/ {
        proxy_pass http://127.0.0.1:8094/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Ichimoku Strategy - Base path /ichimoku
    location /ichimoku/ {
        proxy_pass http://127.0.0.1:8095/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # BigWill Strategy - Base path /bigwill
    location /bigwill/ {
        proxy_pass http://127.0.0.1:8096/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # ElliotV5_SMA_Shorts Strategy - Base path /elliotv5_sma_shorts
    location /elliotv5_sma_shorts/ {
        proxy_pass http://127.0.0.1:8097/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Health check endpoints
    location /health/nfi-x6 {
        access_log off;
        proxy_pass http://127.0.0.1:8080/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/bandtastic {
        access_log off;
        proxy_pass http://127.0.0.1:8082/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/fvg {
        access_log off;
        proxy_pass http://127.0.0.1:8085/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/machetev8b {
        access_log off;
        proxy_pass http://127.0.0.1:8090/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/elliotv5_sma {
        access_log off;
        proxy_pass http://127.0.0.1:8091/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/binclucmadv1 {
        access_log off;
        proxy_pass http://127.0.0.1:8092/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/nasosv4 {
        access_log off;
        proxy_pass http://127.0.0.1:8093/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/martyema {
        access_log off;
        proxy_pass http://127.0.0.1:8094/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/ichimoku {
        access_log off;
        proxy_pass http://127.0.0.1:8095/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/bigwill {
        access_log off;
        proxy_pass http://127.0.0.1:8096/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/elliotv5_sma_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8097/api/v1/ping;
        proxy_set_header Host $host;
    }

    # Security: Block access to sensitive files
    location ~ /\.(ht|env|git) {
        deny all;
        return 404;
    }

    # Logging
    access_log /var/log/nginx/freqtrade_access.log;
    error_log /var/log/nginx/freqtrade_error.log;
}
