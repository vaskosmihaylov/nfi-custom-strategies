# NGINX Configuration for Multi-Strategy Freqtrade - CORRECTED
# This fixes the double-path issue by using simple base paths

# WebSocket upgrade mapping (required for FreqUI)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    listen [::]:80;

    server_name freq.gaiaderma.com;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # CORS headers for cross-origin requests
    add_header Access-Control-Allow-Origin "freq.gaiaderma.com";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE";
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

    # Main FreqUI location - Default to NFI-X6 strategy
    location / {
        proxy_pass http://127.0.0.1:8080;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Strategy-specific paths (FreqUI will append /api/v1/* to these)
    
    # NFI-X6 Strategy - Base path /nfi-x6
    location /nfi-x6/ {
        proxy_pass http://127.0.0.1:8080/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # QuickAdapter Strategy - Base path /quickadapter  
    location /quickadapter/ {
        proxy_pass http://127.0.0.1:8081/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # BandtasticFiboHyper Strategy - Base path /bandtastic
    location /bandtastic/ {
        proxy_pass http://127.0.0.1:8082/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # TrendFollowing Strategy - Base path /trendfollowing
    location /trendfollowing/ {
        proxy_pass http://127.0.0.1:8083/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Renko Strategy - Base path /renko
    location /renko/ {
        proxy_pass http://127.0.0.1:8084/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # FVG Strategy - Base path /fvg
    location /fvg/ {
        proxy_pass http://127.0.0.1:8085/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # PowerTower Strategy - Base path /powertower
    location /powertower/ {
        proxy_pass http://127.0.0.1:8086/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # FastSupertrend Strategy - Base path /fastsupertrend
    location /fastsupertrend/ {
        proxy_pass http://127.0.0.1:8087/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # NoTankAI Strategy - Base path /notankai
    location /notankai/ {
        proxy_pass http://127.0.0.1:8088/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # DTW Strategy - Base path /dtw
    location /dtw/ {
        proxy_pass http://127.0.0.1:8089/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Health check endpoints
    location /health/nfi-x6 {
        access_log off;
        proxy_pass http://127.0.0.1:8080/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/bandtastic {
        access_log off;
        proxy_pass http://127.0.0.1:8082/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/quickadapter {
        access_log off;
        proxy_pass http://127.0.0.1:8081/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/trendfollowing {
        access_log off;
        proxy_pass http://127.0.0.1:8083/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/renko {
        access_log off;
        proxy_pass http://127.0.0.1:8084/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/fvg {
        access_log off;
        proxy_pass http://127.0.0.1:8085/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/powertower {
        access_log off;
        proxy_pass http://127.0.0.1:8086/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/fastsupertrend {
        access_log off;
        proxy_pass http://127.0.0.1:8087/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/notankai {
        access_log off;
        proxy_pass http://127.0.0.1:8088/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/dtw {
        access_log off;
        proxy_pass http://127.0.0.1:8089/api/v1/ping;
        proxy_set_header Host $host;
    }

    # Security: Block access to sensitive files
    location ~ /\.(ht|env|git) {
        deny all;
        return 404;
    }

    # Logging
    access_log /var/log/nginx/freqtrade_access.log;
    error_log /var/log/nginx/freqtrade_error.log;
}