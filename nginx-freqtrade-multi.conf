# NGINX Configuration for Multi-Strategy Freqtrade - CORRECTED
# This fixes the double-path issue by using simple base paths

# WebSocket upgrade mapping (required for FreqUI)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    listen [::]:80;

    server_name freq.gaiaderma.com;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # CORS headers for cross-origin requests
    add_header Access-Control-Allow-Origin "freq.gaiaderma.com";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE";
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

    # Main FreqUI location - Default to NFI-X7 strategy
    location / {
        proxy_pass http://127.0.0.1:8080;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Strategy-specific paths (FreqUI will append /api/v1/* to these)

    # NFI-X7 Strategy - Base path /nfi-x7
    location /nfi-x7/ {
        proxy_pass http://127.0.0.1:8080/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # FalconTrader Strategy - Base path /falcontrader
    location /falcontrader/ {
        proxy_pass http://127.0.0.1:8092/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # FalconTrader_Short Strategy - Base path /falcontrader_short
    location /falcontrader_short/ {
        proxy_pass http://127.0.0.1:8094/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # E0V1E Strategy - Base path /e0v1e
    location /e0v1e/ {
        proxy_pass http://127.0.0.1:8098/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # E0V1E_Shorts Strategy - Base path /e0v1e_shorts
    location /e0v1e_shorts/ {
        proxy_pass http://127.0.0.1:8099/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Auto_EI_t4c0s Strategy (Longs) - Base path /auto_ei_t4c0s
    location /auto_ei_t4c0s/ {
        proxy_pass http://127.0.0.1:8100/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Auto_EI_t4c0s_Shorts Strategy (Shorts) - Base path /auto_ei_t4c0s_shorts
    location /auto_ei_t4c0s_shorts/ {
        proxy_pass http://127.0.0.1:8101/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # ETCG Strategy - Base path /etcg
    location /etcg/ {
        proxy_pass http://127.0.0.1:8102/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # ETCG_Shorts Strategy - Base path /etcg_shorts
    location /etcg_shorts/ {
        proxy_pass http://127.0.0.1:8103/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # ClucHAnix_hhll Strategy - Base path /cluchanix_hhll
    location /cluchanix_hhll/ {
        proxy_pass http://127.0.0.1:8106/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # ClucHAnix_hhll_Shorts Strategy - Base path /cluchanix_hhll_shorts
    location /cluchanix_hhll_shorts/ {
        proxy_pass http://127.0.0.1:8107/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # AwesomeEWOLambo Strategy (Longs) - Base path /awesomeewolambo
    location /awesomeewolambo/ {
        proxy_pass http://127.0.0.1:8108/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # AwesomeEWOLambo_Shorts Strategy (Shorts) - Base path /awesomeewolambo_shorts
    location /awesomeewolambo_shorts/ {
        proxy_pass http://127.0.0.1:8109/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # BB_RPB_TSL_RNG_TBS_GOLD Strategy (Longs) - Base path /bb_rpb_tsl_rng_tbs_gold
    location /bb_rpb_tsl_rng_tbs_gold/ {
        proxy_pass http://127.0.0.1:8110/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # BB_RPB_TSL_RNG_TBS_GOLD_Shorts Strategy (Shorts) - Base path /bb_rpb_tsl_rng_tbs_gold_shorts
    location /bb_rpb_tsl_rng_tbs_gold_shorts/ {
        proxy_pass http://127.0.0.1:8111/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # GeneStrategy_v2 Strategy (Longs) - Base path /genestrategy_v2
    location /genestrategy_v2/ {
        proxy_pass http://127.0.0.1:8114/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # GeneStrategy_v2_Shorts Strategy (Shorts) - Base path /genestrategy_v2_shorts
    location /genestrategy_v2_shorts/ {
        proxy_pass http://127.0.0.1:8115/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # KamaFama Strategy (Longs) - Base path /kamafama
    location /kamafama/ {
        proxy_pass http://127.0.0.1:8091/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # KamaFama_Shorts Strategy (Shorts) - Base path /kamafama_shorts
    location /kamafama_shorts/ {
        proxy_pass http://127.0.0.1:8093/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # HarmonicDivergence Strategy (Longs) - Base path /harmonicdivergence
    location /harmonicdivergence/ {
        proxy_pass http://127.0.0.1:8116/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # HarmonicDivergence_Shorts Strategy (Shorts) - Base path /harmonicdivergence_shorts
    location /harmonicdivergence_shorts/ {
        proxy_pass http://127.0.0.1:8117/;
        include /etc/nginx/conf.d/freqtrade-proxy-headers.conf;
    }

    # Health check endpoints
    location /health/nfi-x7 {
        access_log off;
        proxy_pass http://127.0.0.1:8080/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/falcontrader {
        access_log off;
        proxy_pass http://127.0.0.1:8092/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/falcontrader_short {
        access_log off;
        proxy_pass http://127.0.0.1:8094/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/e0v1e {
        access_log off;
        proxy_pass http://127.0.0.1:8098/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/e0v1e_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8099/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/auto_ei_t4c0s {
        access_log off;
        proxy_pass http://127.0.0.1:8100/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/auto_ei_t4c0s_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8101/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/etcg {
        access_log off;
        proxy_pass http://127.0.0.1:8102/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/etcg_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8103/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/cluchanix_hhll {
        access_log off;
        proxy_pass http://127.0.0.1:8106/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/cluchanix_hhll_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8107/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/awesomeewolambo {
        access_log off;
        proxy_pass http://127.0.0.1:8108/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/awesomeewolambo_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8109/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/bb_rpb_tsl_rng_tbs_gold {
        access_log off;
        proxy_pass http://127.0.0.1:8110/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/bb_rpb_tsl_rng_tbs_gold_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8111/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/genestrategy_v2 {
        access_log off;
        proxy_pass http://127.0.0.1:8114/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/genestrategy_v2_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8115/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/kamafama {
        access_log off;
        proxy_pass http://127.0.0.1:8091/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/kamafama_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8093/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/harmonicdivergence {
        access_log off;
        proxy_pass http://127.0.0.1:8116/api/v1/ping;
        proxy_set_header Host $host;
    }

    location /health/harmonicdivergence_shorts {
        access_log off;
        proxy_pass http://127.0.0.1:8117/api/v1/ping;
        proxy_set_header Host $host;
    }

    # Security: Block access to sensitive files
    location ~ /\.(ht|env|git) {
        deny all;
        return 404;
    }

    # Logging
    access_log /var/log/nginx/freqtrade_access.log;
    error_log /var/log/nginx/freqtrade_error.log;
}
