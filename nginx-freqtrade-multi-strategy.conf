# NGINX Configuration for Multiple Freqtrade Bot Reverse Proxy
# This configuration supports multiple strategies accessible via different URL paths
# Each strategy will be accessible via freq.gaiaderma.com/strategy-name/

# WebSocket upgrade mapping (required for FreqUI)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    listen [::]:80;
    
    server_name freq.gaiaderma.com;
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # Main dashboard - redirect to choose a strategy
    location = / {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>FreqTrade Multi-Strategy Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .strategy-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .strategy-card { padding: 20px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; transition: all 0.3s; }
        .strategy-card:hover { border-color: #4CAF50; transform: translateY(-2px); }
        .strategy-card a { text-decoration: none; color: #333; font-weight: bold; }
        .strategy-card p { margin: 10px 0 0 0; color: #666; font-size: 14px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .active { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>FreqTrade Multi-Strategy Dashboard</h1>
        <p style="text-align: center; color: #666;">Select a strategy to access its FreqUI interface:</p>
        
        <div class="strategy-grid">
            <div class="strategy-card">
                <a href="/nfi/">
                    <strong>NostalgiaForInfinity X6</strong>
                    <p>Original NFI Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
            
            <div class="strategy-card">
                <a href="/bandtastic/">
                    <strong>BandtasticFiboHyper</strong>
                    <p>Fibonacci & Bands Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
            
            <div class="strategy-card">
                <a href="/fvgadvanced/">
                    <strong>FVG Advanced V2</strong>
                    <p>Fair Value Gap Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
            
            <div class="strategy-card">
                <a href="/powertower/">
                    <strong>PowerTower</strong>
                    <p>Power Tower Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
            
            <div class="strategy-card">
                <a href="/trendfollowing/">
                    <strong>TrendFollowing</strong>
                    <p>Trend Following Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
            
            <div class="strategy-card">
                <a href="/adaptiverenko/">
                    <strong>AdaptiveRenko</strong>
                    <p>Adaptive Renko Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
            
            <div class="strategy-card">
                <a href="/quickadapter/">
                    <strong>QuickAdapter</strong>
                    <p>FreqAI QuickAdapter Strategy</p>
                    <span class="status active">Active</span>
                </a>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
            <p>Each strategy runs in its own container with independent configuration.</p>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # NostalgiaForInfinity X6 Strategy (Port 8080)
    location /nfi/ {
        limit_req zone=general burst=20 nodelay;
        
        # Remove /nfi/ prefix before proxying
        rewrite ^/nfi/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /nfi;
        
        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # BandtasticFiboHyper Strategy (Port 8081)
    location /bandtastic/ {
        limit_req zone=general burst=20 nodelay;
        
        rewrite ^/bandtastic/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /bandtastic;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # FVGAdvanced Strategy (Port 8083)
    location /fvgadvanced/ {
        limit_req zone=general burst=20 nodelay;
        
        rewrite ^/fvgadvanced/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8083;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /fvgadvanced;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # PowerTower Strategy (Port 8084)
    location /powertower/ {
        limit_req zone=general burst=20 nodelay;
        
        rewrite ^/powertower/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8084;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /powertower;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # TrendFollowing Strategy (Port 8085)
    location /trendfollowing/ {
        limit_req zone=general burst=20 nodelay;
        
        rewrite ^/trendfollowing/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8085;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /trendfollowing;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # AdaptiveRenko Strategy (Port 8086)
    location /adaptiverenko/ {
        limit_req zone=general burst=20 nodelay;
        
        rewrite ^/adaptiverenko/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8086;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /adaptiverenko;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # QuickAdapter Strategy (Port 8087)
    location /quickadapter/ {
        limit_req zone=general burst=20 nodelay;
        
        rewrite ^/quickadapter/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8087;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Script-Name /quickadapter;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # API endpoint health checks for all strategies
    location /health/ {
        access_log off;
        limit_req zone=api burst=5 nodelay;
        
        # Return a simple health check aggregation
        return 200 '{"status": "healthy", "strategies": ["nfi", "bandtastic", "fvgadvanced", "powertower", "trendfollowing", "adaptiverenko", "quickadapter"]}';
        add_header Content-Type application/json;
    }

    # Individual strategy health checks
    location /health/nfi {
        access_log off;
        proxy_pass http://127.0.0.1:8080/api/v1/ping;
    }
    
    location /health/bandtastic {
        access_log off;
        proxy_pass http://127.0.0.1:8081/api/v1/ping;
    }
    
    location /health/fvgadvanced {
        access_log off;
        proxy_pass http://127.0.0.1:8083/api/v1/ping;
    }
    
    location /health/powertower {
        access_log off;
        proxy_pass http://127.0.0.1:8084/api/v1/ping;
    }
    
    location /health/trendfollowing {
        access_log off;
        proxy_pass http://127.0.0.1:8085/api/v1/ping;
    }
    
    location /health/adaptiverenko {
        access_log off;
        proxy_pass http://127.0.0.1:8086/api/v1/ping;
    }
    
    location /health/quickadapter {
        access_log off;
        proxy_pass http://127.0.0.1:8087/api/v1/ping;
    }

    # Security: Block access to sensitive files
    location ~ /\.(ht|env|git) {
        deny all;
        return 404;
    }
    
    # Block common attack vectors
    location ~ /(\.git|\.env|config\.json)$ {
        deny all;
        return 404;
    }
    
    # Logging
    access_log /var/log/nginx/freqtrade_multi_access.log;
    error_log /var/log/nginx/freqtrade_multi_error.log;
}

# Optional: HTTPS configuration (recommended for production)
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     
#     server_name freq.gaiaderma.com;
#     
#     # SSL configuration (use certbot for Let's Encrypt certificates)
#     ssl_certificate /etc/letsencrypt/live/freq.gaiaderma.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/freq.gaiaderma.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#     
#     # Include all the same location blocks as above
#     # [Copy all location blocks from the HTTP server here]
# }

# HTTP to HTTPS redirect (uncomment when SSL is configured)
# server {
#     listen 80;
#     listen [::]:80;
#     server_name freq.gaiaderma.com;
#     return 301 https://$server_name$request_uri;
# }