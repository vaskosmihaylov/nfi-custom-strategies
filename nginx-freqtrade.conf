# Freqtrade multi-bot reverse proxy (path-based routing)
#
# Each bot advertises a unique ROOT_PATH configured via environment variables.
# Requests arriving on freq.gaiaderma.com/<prefix>/ are forwarded to the matching
# container port exposed on localhost by docker-compose.

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

limit_req_zone $binary_remote_addr zone=freqtrade_api:10m rate=10r/s;

server {
    listen 80;
    listen [::]:80;
    server_name freq.gaiaderma.com;

    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    access_log /var/log/nginx/freqtrade_access.log;
    error_log  /var/log/nginx/freqtrade_error.log;

    # Optional: redirect bare root to the primary bot
    location = / { return 302 /nfi/; }

    # strategy prefixes ------------------------------------------------------
    location = /nfi        { return 302 /nfi/; }
    location /nfi/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8080/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /nfi;
    }

    location = /bandtastic        { return 302 /bandtastic/; }
    location /bandtastic/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8081/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /bandtastic;
    }

    location = /fastsupertrend        { return 302 /fastsupertrend/; }
    location /fastsupertrend/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8082/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /fastsupertrend;
    }

    location = /fvg        { return 302 /fvg/; }
    location /fvg/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8083/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /fvg;
    }

    location = /powertower        { return 302 /powertower/; }
    location /powertower/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8084/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /powertower;
    }

    location = /trend        { return 302 /trend/; }
    location /trend/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8085/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /trend;
    }

    location = /renko        { return 302 /renko/; }
    location /renko/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8086/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /renko;
    }

    location = /quick        { return 302 /quick/; }
    location /quick/ {
        limit_req zone=freqtrade_api burst=15 nodelay;
        proxy_pass http://127.0.0.1:8087/;
        include snippets/freqtrade_proxy_params.conf;
        proxy_set_header X-Forwarded-Prefix /quick;
    }

    # fall-through
    location / {
        return 404;
    }

    location ~ /\.(ht|env|git) {
        deny all;
        return 404;
    }
}
